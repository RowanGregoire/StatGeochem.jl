## -- Perplex name abbreviations

    abbreviations = ("acm", "ak", "ab", "alm", "ames", "anl", "and", "andr", "any", "ank", "ann", "an", "anth", "fanth", "atg", "arag", "azr", "bdy", "mnbi", "bn", "apv", "cpv", "fpv", "mpv", "npv", "br", "cc", "fcar", "mcar", "cel", "fcel", "ccp", "afchl", "mnchl", "fctd", "mctd", "mnctd", "chr", "clin", "chum", "cz", "coe", "crd", "hcrd", "fcrd", "mncrd", "cor", "cv", "crst", "cumm", "daph", "deer", "diam", "dsp", "di", "dol", "east", "en", "ep", "fep", "esk", "fa", "ftr", "fper", "fs", "fo", "nagt", "ged", "geh", "geik", "gl", "fgl", "gth", "gph", "gr", "grun", "hlt", "hed", "hem", "herc", "heu", "abh", "ilm", "oilm", "iron", "jd", "kals", "kls", "kao", "ky", "larn", "lrn", "lmt", "law", "lc", "lime", "mft", "mag", "mt", "maj", "mal", "mang", "ma", "me", "merw", "mic", "mil", "mont", "mu", "cg", "cgh", "ne", "Ni", "bunsn", "osm1", "osm2", "fosm", "pa", "parg", "per", "phA", "phl", "naph", "ppv", "pre", "pswo", "pump", "pyr", "py", "pnt", "prl", "pxmn", "q", "rnk", "rhc", "rhod", "rieb", "frw", "mrw", "ru", "san", "spr4", "spr7", "fspr", "sid", "sill", "spss", "sph", "sp", "spu", "fst", "mst", "mnst", "stlb", "stv", "sud", "fsud", "syv", "ta", "fta", "teph", "ty", "tpz", "tr", "trd", "tro", "tats", "ts", "cats", "mgts", "usp", "vsv", "fwd", "mwd", "wrk", "wo", "wu", "Wu", "zrc", "zo", "CO2", "CO", "H2", "CH4", "O2", "H2O", "abL", "anL", "diL", "enL", "faL", "fliq", "foL", "h2oL", "hliq", "kspL", "mliq", "qL", "silL", "H+", "Cl-", "OH-", "Na+", "K+", "Ca++", "Mg++", "Fe++", "Al+++", "CO3", "AlOH3", "AlOH4-", "KOH", "HCL", "KCL", "NaCl", "CaCl2", "CaCl+", "MgCl2", "MgCl", "FeCl2", "aqSi", "Kf", "San", "San(TH)", "Bi(HGP)", "Bi(W)", "Bio(HP)", "Bio(TCC)", "Bio(WPH)", "Mpv(H)", "Pv", "Pv(fab)", "Pv(stx7)", "B", "C2/c(stx)", "Carb(M)", "Cc(AE)", "dis(EF)", "Do(AE)", "Do(HP)", "DoDo", "M(HP)", "oCcM(EF)", "oCcM(HP)", "Carp", "Carp(M)", "Carp(SGH)", "Chl(HP)", "Chl(LWV)", "Chl(W)", "Ctd(HP)", "Ctd(SGH)", "Ctd(W)", "Act(M)", "Amph(DHP)", "Amph(DPW)", "Ca-Amph(D)", "cAmph_I(DP)", "cAmph_I(G)", "cAmph(DP)", "cAmph(G)", "Cumm", "Gl", "GlTrTsMr", "GlTrTsPg", "Na-Amph(D)", "Tr", "Chum", "TiCh(PL)", "TiChdr(B)", "Augite(G)", "Cps(HGP)", "Cpx_I(HGP)", "Cpx(h)", "Cpx(HGP)", "Cpx(HP)", "Cpx(JH)", "Cpx(l)", "Cpx(m)", "Cpx(stx)", "Cpx(stx7)", "Cpx(stx8)", "Cpx(TH)", "Hpx(H)", "Omph(GHP)", "Omph(HP)", "Crd(HGP)", "Crd(W)", "hCrd", "Cor(H)", "Cpv(H)", "Ep(HP)", "Ep(HP11)", "CF(stx8)", "Cfer(H)", "Fper(H)", "Aq_solven0", "Aqfl(HGP)", "C-H-Fluid", "COH-Fluid", "COH-Fluid", "COH-Fluid+", "COHF", "F", "F(salt)", "GCOHF", "HO-Fluid", "HOS-Fluid", "Si-Fluid", "WADDAH", "CrGt", "Grt(JH)", "Gt(B)", "Gt(EWHP)", "Gt(GCT)", "Gt(HGP)", "Gt(HP)", "Gt(MPF)", "Gt(stx)", "Gt(stx8)", "Gt(TH)", "Gt(W)", "Gt(WPH)", "Gt(WPPH)", "Ygt(SP)", "ZrGt(KP)", "ZrGt(KP)", "CCO-vapor", "ideal_gas", "Si-vapor", "Aki", "Aki(fab)", "Aki(H)", "Aki(stx7)", "Aki(stx8)", "Eskol(C)", "IlGkPy", "IlHm(A)", "Ilm(DS6)", "Ilm(WPH)", "Ilm(WPH0)", "Gt(H)", "Maj", "casmelt", "FeCr(liq)", "FeS_liq", "FeSiC_liq", "LIQ(EF)", "LIQ(NK)", "Melt(A)", "Melt(B)", "melt(G)", "melt(HGP)", "melt(HGPH)", "melt(HP)", "Melt(JH)", "melt(SP)", "melt(TH)", "melt(W)", "MELTS(GS)", "mMELTS(G)", "pMELTS(G)", "Mnz(SP)", "Neph(FB)", "NAl(H)", "O(HGP)", "O(HKP)", "O(HP)", "O(HPK)", "O(JH)", "O(SG)", "O(stx)", "O(stx7)", "O(stx8)", "Ol(m)", "A", "Anth", "o-Amph", "oAmph(DP)", "CrOpx(HP)", "Opx(HGP)", "Opx(HP)", "Opx(JH)", "Opx(stx)", "Opx(stx8)", "Opx(TH)", "Opx(W)", "Osm(HP)", "Osm(HP11)", "Pl(h)", "Pl(JH)", "Pl(stx8)", "Ppv(og)", "Ppv(stx8)", "Pu", "Pu(M)", "Po(HP)", "Po(SE)", "hRg", "Ring", "Ring(H)", "Ring(stx)", "Ring(stx7)", "Ring(stx8)", "ZrRu", "Sa(WP)", "Sapp(HP)", "Sapp(KWP)", "Sapp(TP)", "Scap", "Atg(LE)", "Atg(PN)", "Liz(LE)", "CrSp", "GaHcSp", "MF", "Mt(W)", "MtUl(A)", "Sp_II(WPC)", "Sp(GS)", "Sp(HGP)", "Sp(HP)", "Sp(JH)", "Sp(JR)", "Sp(stx)", "Sp(stx7)", "Sp(stx8)", "Sp(TH)", "Sp(WPC)", "St(HP)", "St(W)", "Stlp", "Stlp(M)", "Sud", "Sud(Livi)", "Sud(M)", "T", "feldspar", "feldspar_B", "Fsp(C1)", "Fsp(HGP)", "lAb(HGP)", "Pl(I1,HP)", "Tour(V)", "hWd", "Wad", "Wad(H)", "Wad(stx)", "Wad(stx7)", "Wad(stx8)", "MaPa", "Mica(CF)", "Mica(CHA)", "Mica(CHA1)", "Mica(M)", "Mica(SGH)", "Mica(W)", "Mica+(CHA)", "Pheng(HP)", "Wus", "Wus(fab)", "Wus(stx7)",)
    common_names = ("acmite", "akermanite", "albite", "almandine", "amesite", "analcite", "andalusite", "andradite", "anhydrite", "ankerite", "annite", "anorthite", "anthophyllite", "anthophyllite-(Fe)", "antigorite", "aragonite", "azurite", "baddeleyite", "biotite-(Mn)", "bornite", "bridgmanite-(Al)", "bridgmanite-(Ca)", "bridgmanite-(Fe)", "bridgmanite", "bridgmanite-(Na)", "brucite", "calcite", "carpholite-(Fe)", "carpholite-(Mg)", "celadonite", "celadonite-(Fe)", "chalcopyrite", "chlorite-(Al-free)", "chlorite-(Mn)", "chloritoid-(Fe)", "chloritoid-(Mg)", "chloritoid-(Mn)", "chrysotile", "clinochlore", "clinohumite", "clinozoisite", "coesite", "cordierite", "cordierite-(OH)", "cordierite-(Fe)", "cordierite-(Mn)", "corundum", "covellite", "cristobalite", "cummingtonite", "daphnite", "deerite", "diamond", "diaspore", "diopside", "dolomite", "eastonite", "enstatite", "epidote", "epidote-(Fe)", "eskolaite", "fayalite", "ferroactinolite", "ferropericlase", "ferrosilite", "forsterite", "garnet-(Na)", "gedrite", "gehlenite", "geikielite", "glaucophane", "glaucophane-(Fe)", "goethite", "graphite", "grossular", "grunerite", "halite", "hedenbergite", "hematite", "hercynite", "heulandite", "highalbite", "ilmenite", "ilmenite", "iron", "jadeite", "kalsilite", "kalsilite", "kaolinite", "kyanite", "larnite", "larnite", "laumontite", "lawsonite", "leucite", "lime", "magnesioferrite", "magnesite", "magnetite", "majorite", "malachite", "manganosite", "margarite", "meionite", "merwinite", "microcline", "millerite", "monticellite", "muscovite", "nepheline", "nepheline", "nepheline", "nickel", "nickel oxide", "osumilite", "osumilite", "osumilite-(Fe)", "paragonite", "pargasite", "periclase", "phase A", "phlogopite", "phlogopite-(Na)", "post-perovskite", "prehnite", "pseudowollastonite", "pumpellyite", "pyrite", "pyrope", "pyrophanite", "pyrophyllite", "pyroxmangite", "quartz", "rankinite", "rhodochrosite", "rhodonite", "riebeckite", "ringwoodite-(Fe)", "ringwoodite-(Mg)", "rutile", "sanidine", "sapphirine", "sapphirine", "sapphirine-(Fe)", "siderite", "sillimanite", "spessartine", "sphene", "spinel", "spurrite", "staurolite-(Fe)", "staurolite-(Mg)", "staurolite-(Mn)", "stilbite", "stishovite", "sudoite", "sudoite-(Fe)", "sylvite", "talc", "talc-(Fe)", "tephroite", "tilleyite", "topaz", "tremolite", "tridymite", "troilite", "tschermak-talc", "tschermakite", "tschermakite-(Ca)", "tschermakite-(Mg)", "ulvospinel", "vesuvianite", "wadsleyite-(Fe)", "wadsleyite-(Mg)", "wairakite", "wollastonite", "wustite", "wustite", "zircon", "zoisite", "carbon dioxide", "carbon monoxide", "hydrogen", "methane", "oxygen", "water", "melt", "melt", "melt", "melt", "melt", "melt", "melt", "melt", "melt", "melt", "melt", "melt", "melt", "H+(aq)", "Cl(aq)", "OH(aq)", "Na+(aq)", "K+(aq)", "Ca2+(aq)", "Mg2+(aq)", "Fe2+(aq)", "Al3+(aq)", "CO3--(aq)", "Al(OH)3(aq)", "Al(OH)4----(aq)", "KOH(aq)", "HCl(aq)", "KCl(aq)", "NaCl(aq)", "CaCl(aq)", "CaCl+(aq)", "MgCl2(aq)", "MgCl+(aq)", "FeCl(aq)", "Si(aq)", "alkali feldspar", "alkali feldspar", "alkali feldspar", "biotite", "biotite", "biotite", "biotite", "biotite", "bridgmanite", "bridgmanite", "bridgmanite", "bridgmanite", "brucite", "C2/c-pyroxene", "carbonate", "carbonate", "carbonate", "carbonate", "carbonate", "carbonate", "carbonate", "carbonate", "carbonate", "carpholite", "carpholite", "carpholite", "chlorite", "chlorite", "chlorite", "chloritoid", "chloritoid", "chloritoid", "clinoamphibole", "clinoamphibole", "clinoamphibole", "clinoamphibole", "clinoamphibole", "clinoamphibole", "clinoamphibole", "clinoamphibole", "clinoamphibole", "clinoamphibole", "clinoamphibole", "clinoamphibole", "clinoamphibole", "clinoamphibole", "clinohumite", "clinohumite", "clinohumite", "clinopyroxene", "clinopyroxene", "clinopyroxene", "clinopyroxene", "clinopyroxene", "clinopyroxene", "clinopyroxene", "clinopyroxene", "clinopyroxene", "clinopyroxene", "clinopyroxene", "clinopyroxene", "clinopyroxene", "clinopyroxene", "clinopyroxene", "clinopyroxene", "cordierite", "cordierite", "cordierite", "corundum", "davemaoite", "epidote", "epidote", "ferrite-(Ca)", "ferrite-(Ca)", "ferropericlase", "fluid", "fluid", "fluid", "fluid", "fluid", "fluid", "fluid", "fluid", "fluid", "fluid", "fluid", "fluid", "fluid", "fluid", "garnet", "garnet", "garnet", "garnet", "garnet", "garnet", "garnet", "garnet", "garnet", "garnet", "garnet", "garnet", "garnet", "garnet", "garnet", "garnet", "garnet", "gas", "gas", "gas", "ilmenite", "ilmenite", "ilmenite", "ilmenite", "ilmenite", "ilmenite", "ilmenite", "ilmenite", "ilmenite", "ilmenite", "ilmenite", "majorite", "majorite", "melt", "melt", "melt", "melt", "melt", "melt", "melt", "melt", "melt", "melt", "melt", "melt", "melt", "melt", "melt", "melt", "melt", "melt", "melt", "monazite", "nepheline", "new aluminous phase", "olivine", "olivine", "olivine", "olivine", "olivine", "olivine", "olivine", "olivine", "olivine", "olivine", "orthoamphibole", "orthoamphibole", "orthoamphibole", "orthoamphibole", "orthopyroxene", "orthopyroxene", "orthopyroxene", "orthopyroxene", "orthopyroxene", "orthopyroxene", "orthopyroxene", "orthopyroxene", "osumilite", "osumilite", "plagioclase", "plagioclase", "plagioclase", "post-perovskite", "post-perovskite", "pumpellyite", "pumpellyite", "pyrrhotite", "pyrrhotite", "ringwoodite", "ringwoodite", "ringwoodite", "ringwoodite", "ringwoodite", "ringwoodite", "rutile", "sapphirine", "sapphirine", "sapphirine", "sapphirine", "scapolite", "serpentine", "serpentine", "serpentine", "spinel", "spinel", "spinel", "spinel", "spinel", "spinel", "spinel", "spinel", "spinel", "spinel", "spinel", "spinel", "spinel", "spinel", "spinel", "spinel", "staurolite", "staurolite", "stilpnomelane", "stilpnomelane", "sudoite", "sudoite", "sudoite", "talc", "ternary feldspar", "ternary feldspar", "ternary feldspar", "ternary feldspar", "ternary feldspar", "ternary feldspar", "tourmaline", "wadsleyite", "wadsleyite", "wadsleyite", "wadsleyite", "wadsleyite", "wadsleyite", "white mica", "white mica", "white mica", "white mica", "white mica", "white mica", "white mica", "white mica", "white mica", "wustite", "wustite", "wustite",)

    @test perplex_common_name.(abbreviations) == common_names

    abbreviations = ("ak", "alm", "and", "andr", "chum", "cz", "crd", "ep", "fa", "fctd", "fcrd", "fep", "fosm", "fst", "fo", "geh", "gr", "hcrd", "tpz", "ky", "larn", "law", "merw", "mctd", "mst", "mnctd", "mncrd", "mnst", "mont", "osm1", "osm2", "phA", "pump", "py", "rnk", "sill", "spss", "sph", "spu", "teph", "ty", "vsv", "zrc", "zo", "acm", "cats", "di", "en", "fs", "hed", "jd", "mgts", "pswo", "pxmn", "rhod", "wo", "anth", "cumm", "fanth", "fgl", "ftr", "ged", "gl", "grun", "parg", "rieb", "tr", "ts", "deer", "fcar", "fspr", "mcar", "spr4", "spr7", "ann", "cel", "east", "fcel", "ma", "mnbi", "mu", "naph", "pa", "phl", "afchl", "ames", "clin", "daph", "fsud", "mnchl", "sud", "atg", "chr", "fta", "kao", "pre", "prl", "ta", "tats", "ab", "anl", "an", "coe", "crst", "heu", "abh", "kals", "lmt", "lc", "me", "mic", "ne", "q", "san", "stlb", "stv", "trd", "wrk", "bdy", "cor", "geik", "hem", "herc", "ilm","oilm","lime", "mft", "mt", "mang", "bunsn", "per", "pnt", "ru", "sp", "usp", "br", "dsp", "gth", "ank", "arag", "cc", "dol", "mag", "rhc", "sid", "diam", "gph", "iron", "Ni", "CO2", "CO", "H2", "CH4", "O2", "H2O", "abL", "anL", "diL", "enL", "faL", "fliq", "foL", "h2oL", "hliq", "kspL", "mliq", "qL", "silL", "H+", "Cl-", "OH-", "Na+", "K+", "Ca++", "Mg++", "Fe++", "Al+++", "CO3", "AlOH3", "AlOH4-", "KOH", "HCL", "KCL", "NaCl", "CaCl2", "CaCl+", "MgCl2", "MgCl", "FeCl2", "aqSi",)
    full_names = ("akermanite", "almandine", "andalusite", "andradite", "clinohumite", "clinozoisite", "cordierite", "epidote(ordered)", "fayalite", "Fe-chloritoid", "Fe-cordierite", "Fe-epidote", "Fe-osumilite", "Fe-staurolite", "forsterite", "gehlenite", "grossular", "hydrous cordierite", "hydroxy-topaz", "kyanite", "larnite-bredigite", "lawsonite", "merwinite", "Mg-chloritoid", "Mg-staurolite", "Mn-chloritoid", "Mn-cordierite", "Mn-staurolite", "monticellite", "osumilite(1)", "osumilite(2)", "phase A", "pumpellyite", "pyrope", "rankinite", "sillimanite", "spessartine", "sphene", "spurrite", "tephroite", "tilleyite", "vesuvianite", "zircon", "zoisite", "acmite", "Ca-tschermaks pyroxene", "Diopside", "enstatite", "ferrosilite", "hedenbergite", "jadeite", "mg-tschermak", "pseudowollastonite", "pyroxmangite", "rhodonite", "wollastonite", "anthophyllite", "cummingtonite", "Fe-anthophyllite", "Fe-glaucophane", "ferroactinolite", "gedrite(Na-free)", "glaucophane", "grunerite", "pargasite", "riebeckite", "tremolite", "tschermakite", "deerite", "fe-carpholite", "fe-sapphirine(793)", "mg-carpholite", "sapphirine(442)", "sapphirine(793)", "annite", "celadonite", "eastonite", "Fe-celadonite", "margarite", "Mn-biotite", "muscovite", "Na-phlogopite", "paragonite", "phlogopite", "Al-free chlorite", "amesite(14Ang)", "clinochlore(ordered)", "daphnite", "Fe-sudoite", "Mn-chlorite", "Sudoite", "antigorite", "chrysotile", "Fe-talc", "Kaolinite", "prehnite", "pyrophyllite", "talc", "tschermak-talc", "albite", "analcite", "anorthite", "coesite", "cristobalite", "heulandite", "highalbite", "kalsilite", "laumontite", "leucite", "meionite", "microcline", "nepheline", "quartz", "sanidine", "stilbite", "stishovite", "tridymite", "wairakite", "baddeleyite", "corundum", "geikielite", "hematite", "hercynite", "ilmenite", "ilmenite(ordered)","lime", "magnesioferrite", "magnetite", "manganosite", "nickel oxide", "periclase", "pyrophanite", "rutile", "spinel", "ulvospinel", "brucite", "diaspore", "goethite", "ankerite", "aragonite", "calcite", "dolomite", "magnesite", "rhodochrosite", "siderite", "diamond", "graphite", "iron", "nickel", "carbon dioxide", "carbon monoxide", "hydrogen", "methane", "oxygen", "water fluid", "albite liquid", "anorthite liquid", "diopside liquid", "enstatite liquid", "fayalite liquid", "Fe-liquid (in KFMASH)", "Forsterite liquid", "H2O liquid", "H2O liquid (in KFMASH)", "K-feldspar liquid", "Mg liquid (in KFMASH)", "Silica liquid", "Sillimanite liquid", "H+(aq)", "Cl(aq)", "OH(aq)", "Na+(aq)", "K+(aq)", "Ca2+(aq)", "Mg2+(aq)", "Fe2+(aq)", "Al3+(aq)", "CO3--(aq)", "Al(OH)3(aq)", "Al(OH)4----(aq)", "KOH(aq)", "HCl(aq)", "KCl(aq)", "NaCl(aq)", "CaCl(aq)", "CaCl+(aq)", "MgCl2(aq)", "MgCl+(aq)", "FeCl(aq)", "Aqueous silica",)

    @test perplex_expand_name.(abbreviations) == full_names
    @test perplex_abbreviate_name.(full_names) == abbreviations
    @test perplex_phase_is_solid.(("melt(HGP)", "q", "diL", "andr", "T(K)")) == (false, true, false, true, false)

    @test findall(germ_perplex_name_matches.(germ_kd["minerals"], germ_kd["minerals"])) == eachindex(germ_kd["minerals"])
    @test exp10.(germ_kd["Zircon"]["U"]) ≈ [101.08785935842519, 103.34369845983417, 104.03608480352291, 103.8121056383997, 101.56030582980546, 96.97102808133381, 95.52301023356834, 95.00949287568258, 95.39266897332027, 95.9409467962996, 98.50992762612668, 96.83692718047344, 94.90891312825929, 94.14624435644276, 94.84337501236026, 93.143381367987, 93.420029480108, 93.19958960795938, 91.52189420022472, 90.90693177101275, 91.31581508909859, 90.79564120578124, 90.5492797115014, 90.5874427795424, 89.86632872800187, 88.32832604918204, 87.50059374786743, 86.84583596975001, 87.03982316141132, 85.37682496239346, 85.25110168263657, 83.97596438380928, 83.41208939448236, 82.55739863925555, 81.94925315891707, 80.96568602098652, 80.85911803728241, 80.39388198932151, 78.44711925516694, 77.76819158050323, 77.44689308921305]

## --- Test PerpleX configuration and queries
@static if Sys.isunix()

    scratchdir = "./"

    # Kelemen (2014) primitive continental basalt excluding Mn and Ti since most melt models can"t handle them..
    elements =       [ "SiO2", "Al2O3",  "FeO",  "MgO",  "CaO", "Na2O",  "K2O",  "H2O",  "CO2",]
    concentrations = [50.0956, 15.3224, 8.5103, 9.2520, 9.6912, 2.5472, 0.8588, 2.0000, 0.6000,]
    composition = NCKFMASHTOCO2trace{Float64}(concentrations, elements)

    # Emphasis on phases from Holland and Powell -- all phases can be used with hp02ver.dat.
    HP_solution_phases = "Omph(HP)\nOpx(HP)\nAnth\nO(HP)\nSp(HP)\nGt(HP)\nfeldspar_B\nMica(CF)\nBio(TCC)\nCtd(HP)\nSt(HP)\nDo(HP)\nT\nB\nF\n"
    HP_excludes = ""

    ## --- # # # # # # # # # # # # # Isobaric example # # # # # # # # # # # # # # # #

    # Input parameters
    P = 1000 # Pressure, bar
    T_range = (0+273.15, 1500+273.15) # Temperature range, Kelvin

    # Configure (run build and vertex)
    melt_model = "melt(HP)"
    @info "perplex_configure_isobar:"
    @time perplex_configure_isobar(scratchdir, composition, P, T_range,
        dataset="hp02ver.dat",
        npoints=100,
        excludes=HP_excludes,
        solution_phases=melt_model*"\n"*HP_solution_phases
    )

    ## --- Query all properties at a single temperature -- results returned as text

    T = 850+273.15
    data_isobaric = perplex_query_point(scratchdir, T)
    @test isfile("./out1/1_1.txt")
    @test isa(data_isobaric, String)

    ## --- Query the full isobar -- results returned as dict

    bulk = perplex_query_system(scratchdir, importas=:Tuple, npoints=100)
    @test isa(bulk, NamedTuple)
    @test haskey(bulk, :SIO2)
    if haskey(bulk, :SIO2)
        @test haskey(bulk, :SIO2) && !isempty(bulk.SIO2)
        @test length(bulk.SIO2) == 100
        @test all(isapprox.(bulk.SIO2, 50.66433039859823, atol=0.1))
    end

    melt = perplex_query_phase(scratchdir, melt_model, importas=:Tuple, npoints=100)
    @test isa(melt, NamedTuple)
    @test haskey(melt, :SIO2)

    if haskey(melt, :SIO2)
        @test !isempty(melt.SIO2) && !any(x->x<45, melt.SIO2) && !any(x->x>75, melt.SIO2)
        @test length(melt.SIO2) == 100
        @test isapprox(melt.SIO2,  [NaN, NaN, NaN, NaN, NaN, NaN, NaN, NaN, NaN, NaN, NaN, NaN, NaN, NaN, NaN, NaN, NaN, NaN, NaN, NaN, NaN, NaN, NaN, NaN, NaN, NaN, NaN, NaN, NaN, NaN, NaN, NaN, NaN, NaN, NaN, NaN, NaN, NaN, NaN, NaN, NaN, NaN, NaN, NaN, NaN, NaN, NaN, NaN, NaN, NaN, NaN, NaN, NaN, NaN, NaN, NaN, NaN, NaN, 66.23928873932091, 66.20069536595133, 66.1129689269046, 65.96817295304906, 65.77167961077932, 65.5254393152636, 65.23386085968349, 64.87278962035367, 64.45898710820259, 64.04463202231602, 63.2097683951158, 62.229362662382414, 61.2299, 60.24657590136964, 59.299682210095334, 58.39293503576102, 57.528805752880565, 56.697199999999995, 55.900244720195786, 55.151072424463784, 54.444161889086686, 53.77171075434216, 53.13486811907912, 52.53058424082473, 51.97033118219873, 51.615110323022066, 51.531989693602064, 51.49388455183463, 51.45425369117167, 51.4165640084052, 51.38137430931284, 51.34737946104821, 51.31412565706284, 51.282015384604605, 51.252599999999994, 51.2249358574551, 51.196284641114616, 51.169935818955075, 51.1451744274128, 51.11510000000001, 50.45745550320106, 50.40943024565815], nans=true, atol = 0.1)
    end

    modes = perplex_query_modes(scratchdir; importas=:Dict, npoints=100)
    @test isa(modes, Dict)
    @test haskey(modes, "Do(HP)")
    if haskey(modes, "Do(HP)")
        @test length(modes["Do(HP)"]) == 100
        @test isapprox(modes["Do(HP)"],  [0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 1.381821359304602, 1.375915226299608, 1.3738211840050927, 1.374457738329655, 1.3705253254297285, 1.366661347624855, 1.3645275034904318, 1.3701797192769967, 1.375450810802064, 1.3797663596440084, 1.38170983102423, 1.3835908068064018, 1.3914280845348614, 1.4096547846120548, 1.4188273299579084, 1.417632212772262, 1.416519868920687, 1.415345984868765, 1.415345984868765, 1.4144863360848499, 1.4126771598516183, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0], nans=true, atol = 0.1)
    end
    if haskey(modes, "Omph(HP)")
        @test length(modes["Omph(HP)"]) == 100
        @test isapprox(modes["Omph(HP)"],[0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 2.0339723566900236, 14.960931973118665, 15.062263362661524, 15.164506420058737, 15.268082701516247, 15.372961492756188, 15.47935889951888, 16.023147006631838, 17.195113428726106, 18.546171502024475, 18.513626566383596, 18.921480372141023, 18.938381437801173, 18.95517180349422, 18.971868712229128, 18.987725829804052, 19.003917068704503, 19.019482276868484, 19.034156503334277, 19.04772018291329, 18.955385576325604, 18.66836547025949, 18.700498131123354, 18.672603711178727, 18.689706911851058, 18.70741316163515, 18.726321687261198, 18.74703357720072, 18.769573446275686, 18.793658820257388, 18.821264934638325, 18.852397423440955, 18.8867110753726, 18.978007255636545, 19.10394367818196, 19.245715839150208, 19.40418088373046, 19.579886180363193, 19.774964084364957, 19.991810067185163, 20.241688665240932, 20.52557287224623, 20.84732371711889, 21.210565263460555, 21.618170448738216, 22.09663695953447, 22.646817318444732, 23.25441852307975, 23.214082721363855, 22.81470048851166, 22.43291893689257, 22.066189222773463, 21.721311293034898, 21.399604352976905, 21.097623567233256, 20.8182863046844, 20.557653077344202, 20.318180516294838, 20.09688085563381, 19.885716974177978, 19.695776424220245, 19.521123834193872, 18.711834731308517, 0.0, 0.0], nans=true, atol = 0.1)
    end

    # --- # # # # # # # # # # # Geothermal gradient example # # # # # # # # # # # #

    # Input parameters
    P_range = (280, 28000) # Pressure range to explore, bar (roughly 1-100 km depth)
    T_surf = 273.15 # Temperature of surface (K)
    geotherm = 0.01 # For reference, a geothermal gradient of 0.1 K/bar ≈ 28.4 K/km
    melt_model = ""

    # Configure (run build and vertex)
    @info "perplex_configure_geotherm:"
    @time perplex_configure_geotherm(scratchdir, composition, P_range, T_surf, geotherm;
        dataset="hp02ver.dat",
        excludes=HP_excludes,
        solution_phases=HP_solution_phases,
        npoints=100,
        index=2
    )

    seismic = perplex_query_seismic(scratchdir, index=2)
    @test isa(seismic, Dict)
    @test haskey(seismic, "T(K)")
    @test isa(seismic["T(K)"], Vector{Float64})
    @test nanminimum(seismic["T(K)"]) ≈ T_surf atol = 10
    @test nanmaximum(seismic["T(K)"]) ≈ T_surf + last(P_range)*geotherm atol = 10

    seismic = perplex_query_seismic(scratchdir, index=2, npoints=100)
    @test isa(seismic, Dict)
    @test haskey(seismic, "T(K)")
    @test isa(seismic["T(K)"], Vector{Float64})
    @test length(seismic["T(K)"]) == 100
    @test isapprox(seismic["T(K)"], [275.95, 278.75, 281.55, 284.35, 287.15, 289.95, 292.75, 295.55, 298.35, 301.15, 303.95, 306.75, 309.55, 312.35, 315.15, 317.95, 320.75, 323.55, 326.35, 329.15, 331.95, 334.75, 337.55, 340.35, 343.15, 345.95, 348.75, 351.55, 354.35, 357.15, 359.95, 362.75, 365.55, 368.35, 371.15, 373.95, 376.75, 379.55, 382.35, 385.15, 387.95, 390.75, 393.55, 396.35, 399.15, 401.95, 404.75, 407.55, 410.35, 413.15, 415.95, 418.75, 421.55, 424.35, 427.15, 429.95, 432.75, 435.55, 438.35, 441.15, 443.95, 446.75, 449.55, 452.35, 455.15, 457.95, 460.75, 463.55, 466.35, 469.15, 471.95, 474.75, 477.55, 480.35, 483.15, 485.95, 488.75, 491.55, 494.35, 497.15, 499.95, 502.75, 505.55, 508.35, 511.15, 513.95, 516.75, 519.55, 522.35, 525.15, 527.95, 530.75, 533.55, 536.35, 539.15, 541.95, 544.75, 547.55, 550.35, 553.15], nans=true, atol = 0.1)

    ## --- # # # # # # # # # # # P–T path example # # # # # # # # # # # #

    # Input parameters
    T_range = (550+273.15, 1050+273.15) #K
    PTdir = ""
    PTfilename = ""

    @info "perplex_configure_path:"
    @time perplex_configure_path(scratchdir, concentrations, PTdir, PTfilename, uppercase.(elements), T_range, 
        dataset = "hp02ver.dat", 
        solution_phases=HP_solution_phases, 
        excludes=HP_excludes,
        index=1, 
    )
    
    modes = perplex_query_modes(scratchdir, index=1, npoints=100)
    @test isa(modes, Dict)
    @test haskey(modes,"node")
    @test haskey(modes, "O(HP)")
    if haskey(modes, "O(HP)")
        @test isapprox(modes["O(HP)"], [0.13263234069934907])
    end

    # --- # # # # # # # # # # # Pseudosection example # # # # # # # # # # # # #

    P_range = (1000, 5000) # Pressure range to explore, bar
    T_range = (400+273.15, 600+273.15) # Temperature range to explore, K
    melt_model = ""

    solution_phases = "Opx(HP)\nO(HP)\nF\n"
    excludes = ""

    # Configure (run build and vertex)
    @info "perplex_configure_pseudosection:"
    @time perplex_configure_pseudosection(scratchdir, composition, P_range, T_range, 
        dataset="hp02ver.dat", 
        excludes=excludes,
        solution_phases=melt_model*solution_phases, 
        index=1, xnodes=50, ynodes=50
    )

    # Query modes on diagonal line across P-T space
    modes = perplex_query_modes(scratchdir, P_range, T_range, index=1, npoints=200)
    @test isa(modes, Dict) && !isempty(modes)
    @test haskey(modes,"T(K)") && all(extrema(modes["T(K)"]) .≈ T_range)
    @test length(modes["T(K)"]) == length(modes["Opx(HP)"]) == 200
    @test nanmean(modes["Opx(HP)"]) ≈ 10.047218620689655 rtol=0.01

    phase = perplex_query_phase(scratchdir, "Opx(HP)", P_range, T_range, index=1, npoints=200)
    @test isa(phase, Dict) && !isempty(phase)
    @test haskey(phase,"T(K)") && all(extrema(phase["T(K)"]) .≈ T_range)
    @test length(phase["T(K)"]) == length(phase["SIO2"]) == 200
    @test nanmean(phase["SIO2"]) ≈ 49.11688856598355 rtol=0.01

    sys = perplex_query_system(scratchdir, P_range, T_range, index=1, npoints=200)
    @test isa(sys, Dict) && !isempty(sys)
    @test haskey(sys,"T(K)") && all(extrema(sys["T(K)"]) .≈ T_range)
    @test length(sys["T(K)"]) == length(sys["rho,kg/m3"]) == 200
    @test nanmean(sys["rho,kg/m3"]) ≈ 2849.430250000001 rtol=0.01

    # Query seismic properties on diagonal line across P-T space
    seismic = perplex_query_seismic(scratchdir, P_range, T_range, index=1, npoints=200)
    @test isa(seismic, Dict) && !isempty(seismic)
    @test haskey(seismic,"T(K)") && !isempty(seismic["T(K)"]) && all(extrema(seismic["T(K)"]) .≈ T_range)
    @test length(seismic["T(K)"]) == length(seismic["rho,kg/m3"])  == 200
    @test nanmean(seismic["rho,kg/m3"]) ≈ 2908.4681500000006 rtol=0.01

    # Query properties on a manually-specified diagonal P-T line
    P = range(first(P_range), last(P_range), length=16)
    T = range(first(T_range), last(T_range), length=16)

    modes = perplex_query_modes(scratchdir, P, T, index=1)
    @test isa(modes, Dict) && !isempty(modes)
    @test haskey(modes,"T(K)") && all(isapprox.(modes["T(K)"], T, atol=0.1))
    @test length(modes["Opx(HP)"]) == 16
    @test modes["Opx(HP)"] ≈ [NaN, NaN, NaN, NaN, NaN, NaN, NaN, 5.14854, 9.1865, 10.3581, 10.362, 10.3658, 10.3688, 10.3719, 13.7688, 14.572] nans=true rtol=0.01

    phase = perplex_query_phase(scratchdir, "Opx(HP)", P, T, index=1)
    @test isa(phase, Dict) && !isempty(phase)
    @test haskey(phase,"T(K)") && all(isapprox.(phase["T(K)"], T, atol=0.1))
    @test haskey(phase,"SIO2") && length(phase["SIO2"]) == 16
    @test phase["SIO2"] ≈ [NaN, NaN, NaN, NaN, NaN, NaN, NaN, 49.019009803801964, 48.99169510083049, 49.01006569295402, 49.04348038260784, 49.07787546106227, 49.110609822121965, 49.14480982896197, 49.31759013648197, 49.55400991080199] nans=true rtol=0.01

    sys = perplex_query_system(scratchdir, P, T, index=1)
    @test isa(sys, Dict) && !isempty(sys)
    @test haskey(sys,"T(K)") && all(isapprox.(sys["T(K)"], T, atol=0.1))
    @test haskey(sys, "rho,kg/m3") && length(sys["rho,kg/m3"]) == 16
    @test sys["rho,kg/m3"] ≈ [2875.21, 2875.21, 2875.21, 2875.21, 2875.2, 2874.94, 2874.93, 2833.74, 2825.41, 2824.65, 2826.44, 2828.01, 2829.42, 2830.68, 2840.64, 2844.03] nans=true rtol=0.01

    seismic = perplex_query_seismic(scratchdir, P, T, index=1)
    @test isa(seismic, Dict) && !isempty(seismic)
    @test haskey(seismic,"T(K)") && all(isapprox.(sys["T(K)"], T, atol=0.1))
    @test haskey(seismic, "rho,kg/m3") && length(sys["rho,kg/m3"]) == 16
    @test seismic["rho,kg/m3"] ≈ [2875.21, 2875.21, 2875.21, 2875.21, 2875.2, 2875.34, 2875.32, 2905.4, 2927.22, 2933.56, 2933.46, 2933.36, 2933.26, 2933.15, 2956.4, 2962.18] nans=true atol=0.1

    ## --- # # # # # # # # Isobaric example with more advanced models # # # # # # # # #

    # Kelemen (2014) primitive continental basalt
    elements =       [ "SiO2", "TiO2", "Al2O3",  "FeO",  "MgO",  "CaO", "Na2O",  "K2O",  "H2O",  "CO2",  "Mn",  "P",  "La",  "Ce", "Pr",  "Nd", "Sm", "Eu", "Gd", "Tb", "Dy", "Ho", "Er", "Tm", "Yb", "Lu",  "Sc",    "V",   "Cr", "Co",   "Ni",  "Cu", "Zn",  "Rb",  "Sr",   "Y", "Zr", "Nb", "Cs",   "Ba", "Hf", "Ta", "Pb", "Th",  "U",]
    concentrations = [50.0956, 0.9564, 15.3224, 8.5103, 9.2520, 9.6912, 2.5472, 0.8588, 2.0000, 0.6000, 1316., 960., 11.85, 25.87, 2.85, 14.88, 3.43, 1.07, 3.55, 0.51, 3.32, 0.68, 1.95, 0.29, 1.82, 0.28, 32.51, 246.59, 397.96, 41.2, 158.74, 91.91, 81.3, 18.63, 425.7, 18.69, 92.7, 6.23, 0.71, 295.04, 2.14, 0.45, 3.36, 2.03, 0.53,]
    composition = NCKFMASHTOCO2trace{Float64}(concentrations, elements)

    P = 5000 # Pressure, bar
    T_range = (750+273.15, 1250+273.15) # Temperature range, Kelvin
    solution_phases = "melt(HGPH)\nFsp(HGP)\nlAb(HGP)\nGt(HGP)\nO(HGP)\nOpx(HGP)\nCpx(HGP)\nIlm(WPH)\n"

    # Configure (run build and vertex)
    @info "perplex_configure_isobar:"
    @time perplex_configure_isobar(scratchdir, composition, P, T_range; solution_phases, index=3, npoints=32)

    results = perplextrace_query(scratchdir, composition, index=3, npoints=8)
    @test results isa Dict{String, Union{Vector{Float64}, Vector{String}}}
    expected = Dict{String, Union{Vector{Float64}, Vector{String}}}("Melt_Cs" => [4.3807785738170395, 3.92894046410235, 3.2273205678269345, 2.3617677778564414, 1.4837043354857897, 0.8582560782449095, 0.7154946383251302, 0.71], "phl" => [6.398824153307638, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0], "Melt_CaO" => [2.6609300798279025, 3.069411227764491, 3.7405411969731834, 5.132378870876649, 7.266098982746142, 9.67852203248963, 9.798792743661966, 9.714250971425097], "Melt_La" => [107.71282257841442, 55.3889222688839, 48.15244279761151, 37.14226706762199, 24.077988215129157, 14.265228937498525, 11.942307596761301, 11.85], "Melt_Co" => [37.82794960790027, 34.609539701355246, 30.878444713389335, 31.305231656798366, 33.95742865033759, 35.31383251256509, 40.0155556852075, 41.2], "Melt_v0_{T}" => [0.000114817, 3.65941e-5, -3.98635e-5, -0.000116592, -0.000181218, -0.000221995, -0.000231962, -0.000233658], "Fsp(HGP)" => [44.45050245829608, 34.231557933095715, 31.257652406334994, 26.780559478011824, 18.664716278923667, 3.8237420385117957, 0.0, 0.0], "Melt_Sm" => [18.962169757187894, 12.077510233589104, 10.941068886981878, 8.989951601745812, 6.28273825972156, 4.048818084446303, 3.4566004111311837, 3.43], "Melt_Nd" => [94.98303117762997, 57.73769995701819, 52.026170529684435, 41.957340118006904, 28.475794764782435, 17.712899114745788, 14.995700447892558, 14.88], "Fsp(HGP)_anorthite" => [32.47522913452315, 27.744975282603242, 26.056087906323025, 22.957300355226316, 16.4598265740136, 3.4761261546761384, NaN, NaN], "Melt_Th" => [45.836421528163626, 12.401719382394585, 9.970702851013517, 7.118569114930372, 4.350911975171316, 2.462565252340433, 2.045813735913323, 2.03], "Melt_Gruneisen_T" => [0.795603, 0.731129, 0.660655, 0.576404, 0.490805, 0.421119, 0.396404, 0.381416], "CO2" => [0.5945261089399303, 0.5488135683607758, 0.524324463961817, 0.4854929863263197, 0.4159121461680162, 0.28980041935463613, 0.1737955962773984, 0.07132446565798997], "Melt_Rb" => [164.02705541761335, 106.05536934692711, 86.05589677633212, 62.758222158213535, 39.27574664017566, 22.55284497509877, 18.77489969840294, 18.63], "Melt_Tb" => [2.4852598176218685, 1.6360261877500075, 1.4589340104118953, 1.2167870831890526, 0.888947967374404, 0.595984238920361, 0.513920033767597, 0.51], "Melt_Ta" => [5.6276336410986305, 2.3023337071862695, 1.8945280688608295, 1.4354740023164771, 0.9401799791208216, 0.5445326616537787, 0.4534674087559048, 0.45], "Ilm(WPH)" => [1.5576962883206913, 1.3640757024602723, 1.2018675880620904, 0.902487255191834, 0.27562101597951416, 0.0, 0.0, 0.0], "Melt_vp_{T}" => [0.000114817, 3.65941e-5, -3.98635e-5, -0.000116592, -0.000181218, -0.000221995, -0.000231962, -0.000233658], "apatite" => [0.35031552224005097, 0.22195566127993935, 0.08940754562395573, NaN, NaN, NaN, NaN, NaN], "Melt_Hf" => [8.052694942372872, 9.921037029870721, 8.27577125765554, 6.337616500020168, 4.2300047362611, 2.560666634797426, 2.15656424921494, 2.14], "Melt_Gd" => [18.80375474227807, 12.092772353266994, 10.833042656348605, 8.947484971608894, 6.381249535813257, 4.174480507836172, 3.5774660115268717, 3.55], "all_melts" => [2.6263305728136292, 18.01792741708122, 22.863400572189015, 31.857087224785346, 50.4261962358569, 84.79075525052974, 99.05248159831808, 99.928675534342], "melt(HGPH)" => [2.615789112058797, 18.01792741708122, 22.863400572189015, 31.857087224785346, 50.4261962358569, 84.79075525052974, 99.05248159831808, 99.928675534342], "Melt_Sr" => [238.5401146702037, 333.09064295289795, 359.55150657845337, 386.45265207274036, 414.57479599491586, 453.65496409756287, 429.01625152357866, 425.7], "Melt_FeO" => [1.2893300386799014, 2.0608008243203293, 3.703161185011579, 6.111788655406496, 8.391188825233563, 8.486911782251475, 8.491422377598264, 8.530540853054086], "Melt_CO2" => [0.24641600739248024, 0.28962711585084633, 0.3353581073145943, 0.36257192023417756, 0.36704394861384715, 0.3670190770740062, 0.4312891207609537, 0.5300520530052053], "Fsp(HGP)_orthoclase" => [0.061409338074801936, 0.0381586419676194, 0.028091023266961383, 0.018116473531890213, 0.008542433627222668, 0.00108363756225604, NaN, NaN], "Melt_Al2O3" => [20.41090061232702, 20.21140808456323, 19.120406118529957, 17.72929609955486, 16.503197689552323, 16.24870341222772, 15.494704338517213, 15.358801535880154], "Cpx(HGP)" => [20.693057283105805, 20.50425716105938, 20.59022239092929, 19.79315941567233, 15.811875542301177, 4.269512556954739, 0.0, 0.0], "zircon" => [0.01387430204849468, NaN, NaN, NaN, NaN, NaN, NaN, NaN], "Melt_vol_pct" => [3.53173, 23.4862, 28.4711, 37.1977, 54.567, 86.2054, 98.7985, 99.7573], "Melt_T(K)" => [1023.15, 1094.58, 1166.01, 1237.44, 1308.86, 1380.29, 1451.72, 1523.15], "Melt_wt_pct" => [2.62633, 18.0179, 22.8634, 31.8571, 50.4262, 84.7908, 99.0525, 99.9287], "Melt_MgO" => [0.7710590231317708, 1.3487405394962158, 2.181990698237023, 3.4848192333397687, 5.230319267755302, 7.209231513938619, 9.002832520793104, 9.274010927401093], "Melt_P(bar)" => [5000.0, 5000.0, 5000.0, 5000.0, 5000.0, 5000.0, 5000.0, 5000.0], "Fsp(HGP)_albite" => [11.91386398569813, 6.448424008524857, 5.173473476745006, 3.8051426492536207, 2.196347271282845, 0.3465322462734016, NaN, NaN], "Melt_v0_{P}" => [9.61573e-5, 0.000100458, 0.000107143, 0.000113736, 0.000121071, 0.000130132, 0.000142155, 0.000154029], "Melt_Sc" => [48.544082879308675, 39.928300259326, 34.89855310413763, 33.43064485506579, 33.255909345847314, 33.05943362715673, 32.706567492819886, 32.51], "Melt_Eu" => [1.2847846803727667, 1.633449600853062, 1.6849799479275993, 1.67158608363224, 1.5098929992719738, 1.2211261468253185, 1.0782786555551913, 1.07], "Melt_vp,km/s" => [2.46944, 2.45714, 2.43666, 2.42045, 2.43433, 2.48962, 2.4558, 2.38398], "Melt_Dy" => [15.917453206942021, 10.522035956467006, 9.391123738679585, 7.823617079781619, 5.725599614887173, 3.871238140166807, 3.345552266706226, 3.32], "sphene" => [0.010541460754832496, NaN, NaN, NaN, NaN, NaN, NaN, NaN], "Melt_M" => [2.035559267559843, 2.08816607810154, 2.1833364839321585, 2.409727584950793, 2.8041342853462816, 3.219638995782255, 3.398384934098518, 3.415409159061836], "Melt_alpha,1/K" => [0.000216935, 0.000194271, 0.00017398, 0.000150311, 0.000124586, 0.000102181, 9.95389e-5, 0.000101709], "parg_dqf" => [0.024659042122748626, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0], "Melt_ApSat_P" => [1549.6850659862916, 2262.822995261286, 3199.0512110529494, 4812.022719429285, 7557.273774130887, 11099.700621377684, 15317.391719793734, 20283.71903509682], "Melt_cp,J/K/mol" => [138.996, 152.929, 167.712, 188.261, 213.184, 234.428, 240.882, 239.587], "Melt_Nb" => [106.53312552577758, 35.16022177623563, 28.31699842118738, 20.878163273203693, 13.269705171156733, 7.55869373972152, 6.278457546671376, 6.23], "Melt_Ks,bar" => [126916.0, 130148.0, 133112.0, 138982.0, 149845.0, 163035.0, 159494.0, 149132.0], "all_fluids" => [0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0], "Melt_ZrnSat_Zr" => [371.03100107208974, 751.4551994699366, 1477.5228085365966, 3168.895390233873, 7819.499901932037, 18882.931007944448, 33312.31869871125, 47096.71721855231], "Melt_Zr" => [371.03100107208974, 484.84949960464155, 396.1185967285584, 294.3463545933906, 189.63253802024687, 111.5643146973494, 93.41675702337794, 92.7], "Melt_Yb" => [9.771842059347758, 6.413814539983511, 5.532900545715487, 4.507777825821919, 3.244455638820793, 2.1338357218765736, 1.8338578095603062, 1.82], "Melt_v0,km/s" => [2.46944, 2.45714, 2.43666, 2.42045, 2.43433, 2.48962, 2.4558, 2.38398], "Melt_rho,kg/m3" => [2081.24, 2155.66, 2241.97, 2372.28, 2528.63, 2630.35, 2644.59, 2624.01], "Melt_n,mol" => [0.0313656, 0.188698, 0.212798, 0.258096, 0.355221, 0.543061, 0.621699, 0.631058], "Melt_W" => [NaN, NaN, NaN, NaN, NaN, NaN, NaN, NaN], "Melt_Ce" => [235.65021854179318, 119.72871172727177, 104.7317525230194, 81.3980964141365, 52.612028488214285, 31.129373567172983, 26.071373199624688, 25.87], "Melt_Na2O" => [7.154550214636507, 6.374772549909019, 6.106941954221425, 5.272948839951255, 4.034599435156079, 2.9081706107158287, 2.5758407212354015, 2.5532602553260255], "Melt_K2O" => [3.8781601163448034, 4.5700418280167305, 3.6345811630659726, 2.6353894202143278, 1.6842097642106328, 1.0124902126229447, 0.8684582431683079, 0.8608430860843087], "Melt_vp_P" => [9.61573e-5, 0.000100458, 0.000107143, 0.000113736, 0.000121071, 0.000130132, 0.000142155, 0.000154029], "Melt_Ba" => [347.61348505562717, 517.2979532516068, 539.4907106066212, 531.3437719092601, 462.5462498061484, 344.8354560291108, 297.3387040067245, 295.04], "Melt_Mo" => [NaN, NaN, NaN, NaN, NaN, NaN, NaN, NaN], "Melt_cp/cv" => [1.17659, 1.15547, 1.13402, 1.10721, 1.08003, 1.05939, 1.05728, 1.05909], "Melt_mol_pct" => [6.23248, 34.4653, 38.5725, 46.1126, 61.4115, 87.4384, 98.5611, 99.7443], "Melt_Lu" => [1.3812464976219765, 0.9438971889745296, 0.8249780113861591, 0.6761958408790804, 0.4906738637682081, 0.32710129558170664, 0.28211333808302586, 0.28], "Melt_Ks_{P}" => [11.0606, 11.7975, 12.8403, 14.1686, 15.9852, 18.1029, 19.522, 20.3299], "Melt_P" => [1549.6850659862916, 2262.822995261286, 3199.0512110529494, 3076.476803740618, 1982.700851244752, 1158.3502677811612, 967.2223949607456, 960.0], "Melt_N,g" => [83.5936, 95.3269, 107.263, 123.226, 141.721, 155.875, 159.061, 158.088], "H2O" => [1.357674185823274, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0], "Melt_SiO2" => [49.159501474785046, 50.38012015204805, 51.64451652624529, 51.96988856662452, 51.222692828823, 50.63501063335224, 50.34701409716394, 50.2148050214805], "Melt_Cr" => [189.1830399870999, 190.2319107370144, 172.46785336612618, 177.6288269633674, 213.65213714905593, 314.9400668670011, 397.3668416694425, 397.96], "Opx(HGP)" => [20.30110651588041, 21.4798776471744, 19.63072764349442, 16.08410186086329, 10.4339387019774, 3.4466656354202168, 0.0, 0.0], "elements" => ["P(bar)", "T(C)", "all_fluids", "all_melts", "all_solids", "melt(HGPH)", "apatite", "CO2", "Cpx(HGP)", "Fsp(HGP)", "Fsp(HGP)_albite", "Fsp(HGP)_anorthite", "Fsp(HGP)_orthoclase", "H2O", "Ilm(WPH)", "O(HGP)", "Opx(HGP)", "parg_dqf", "phl", "sphene", "zircon", "Melt_T(K)", "Melt_P(bar)", "Melt_V,J/bar/mol", "Melt_Gruneisen_T", "Melt_Ks,bar", "Melt_v0,km/s", "Melt_vp,km/s", "Melt_rho,kg/m3", "Melt_cp,J/K/mol", "Melt_alpha,1/K", "Melt_beta,1/bar", "Melt_S,J/K/mol", "Melt_n,mol", "Melt_N,g", "Melt_Ks_{P}", "Melt_v0_{T}", "Melt_vp_{T}", "Melt_v0_{P}", "Melt_vp_P", "Melt_cp/cv", "Melt_vol_pct", "Melt_wt_pct", "Melt_mol_pct", "Melt_SiO2", "Melt_TiO2", "Melt_Al2O3", "Melt_FeO", "Melt_MgO", "Melt_CaO", "Melt_Na2O", "Melt_K2O", "Melt_H2O", "Melt_CO2", "Melt_M", "Melt_ZrnSat_Zr", "Melt_ApSat_P", "Melt_P", "Melt_Rb", "Melt_Cs", "Melt_Sr", "Melt_Ba", "Melt_Sc", "Melt_V", "Melt_Cr", "Melt_Mn", "Melt_Co", "Melt_Ni", "Melt_La", "Melt_Ce", "Melt_Nd", "Melt_Sm", "Melt_Eu", "Melt_Gd", "Melt_Tb", "Melt_Dy", "Melt_Yb", "Melt_Lu", "Melt_Y", "Melt_Zr", "Melt_Hf", "Melt_Nb", "Melt_Ta", "Melt_Mo", "Melt_W", "Melt_Th", "Melt_U"], "all_solids" => [119.01267740749093, 104.49916802547261, 97.53427774102964, 84.64400890494343, 59.867451335932, 18.36610996553585, 0.7737228054045144, 0.0], "Melt_TiO2" => [0.22102542530807678, 0.5765732306292922, 0.7703502465120788, 1.012439777263249, 1.3278598140996258, 1.0912702291667482, 0.9671552708034756, 0.9586750958675097], "Melt_U" => [11.08470446814946, 3.2718554560163535, 2.6156699761371875, 1.8619682477482882, 1.1369891700325365, 0.6430857502734179, 0.5341317151645298, 0.53], "Melt_Mn" => [2742.5597633929015, 2045.2349073310907, 1794.768900921407, 1714.2633355675173, 1635.3754850621285, 1384.0650601908997, 1315.1841996351006, 1316.0], "P(bar)" => [5000.0, 5000.0, 5000.0, 5000.0, 5000.0, 5000.0, 5000.0, 5000.0], "Melt_beta,1/bar" => [9.27062e-6, 8.8781e-6, 8.5193e-6, 7.96658e-6, 7.20765e-6, 6.49797e-6, 6.62898e-6, 7.10169e-6], "O(HGP)" => [1.995623391389803, 3.8534905707682343, 3.9318049350283624, 4.097111779149035, 3.971740078793336, 3.3795240992288798, 0.7737228054045144, 0.0], "Melt_S,J/K/mol" => [266.024, 295.663, 326.782, 364.603, 405.521, 437.653, 455.528, 465.238], "Melt_H2O" => [14.044600421338014, 11.118504447401778, 8.762152803888897, 6.288478616534705, 3.9727894438094773, 2.3626704961608045, 2.0224905662973582, 2.0047602004760203], "Melt_V" => [367.5628130043417, 359.56813029380106, 341.56848763447925, 321.4254444125121, 298.4900344162308, 265.0379427105873, 248.29954458628796, 246.59], "Melt_Ni" => [26.826807048812558, 66.79056885138615, 63.753608156568106, 63.47239143252069, 69.43078028149573, 94.68400701103671, 144.38846897558585, 158.74], "Melt_V,J/bar/mol" => [4.01654, 4.42217, 4.78434, 5.19443, 5.60468, 5.92603, 6.01458, 6.02468], "T(C)" => [750.0, 821.43, 892.86, 964.2900000000001, 1035.71, 1107.1399999999999, 1178.5700000000002, 1250.0], "Melt_Y" => [84.4254018350977, 57.007322296187695, 51.181332619218146, 42.90891744289474, 31.79025307664329, 21.717332079855346, 18.83290022416441, 18.69])
    for k in expected["elements"]
        @test haskey(results,k)
        if haskey(results, k)
            @test results[k] ≈ expected[k] nans=true rtol=0.01
        end
    end
    # @info results

    results = perplextrace_query(scratchdir, composition; index=3, npoints=16, 
        export_bulk_kds=true, 
        export_mineral_kds=true, 
        export_mineral_compositions=true,
    )
    @test results isa Dict{String, Union{Vector{Float64}, Vector{String}}}
    @test results["zircon"] ≈[0.01387430204849468, 0.0009745402558464423, NaN, NaN, NaN, NaN, NaN, NaN, NaN, NaN, NaN, NaN, NaN, NaN, NaN, NaN]  nans=true atol=0.1
    @test results["Melt_TiO2"] ≈ [0.22102542530807678, 0.4901310686183496, 0.5649919209011312, 0.6494052013156122, 0.7419696067561085, 0.8450781267617189, 0.9593759328436849, 1.0877893146927318, 1.2335094942611076, 1.4051201264608117, 1.2409690320441547, 1.0339308581626123, 0.9871016742564476, 0.9638395180802412, 0.9591408369460578, 0.9586750958675097]  nans=true atol=0.1
    @test results["Zircon_Ti"] ≈ [10.46178465494583, 14.70993086274441, NaN, NaN, NaN, NaN, NaN, NaN, NaN, NaN, NaN, NaN, NaN, NaN, NaN, NaN]  nans=true atol=0.1
    @test results["Melt_Yb"] ≈ [9.771842059347758, 6.954809917920463, 6.457533445209515, 6.054510079488616, 5.638138232603931, 5.254905632399795, 4.746281970262138, 4.176169784182882, 3.5729985704176053, 2.9879385553811266, 2.472195753407615, 2.003815061485148, 1.8699271867091483, 1.8278546707474832, 1.82, 1.82]  nans=true atol=0.1
    @test results["O(HGP)_Yb"] ≈ [0.2380671314000978, 0.1694370044600156, 0.16167790170801283, 0.15620035139164637, 0.15083902601269172, 0.14058627417045713, 0.1269788926841008, 0.11172648784434838, 0.09558964361496733, 0.07708584941799299, 0.06378019696414836, 0.051696439946184766, 0.04824226565090334, 0.04576417765406641, NaN, NaN]  nans=true atol=0.1
    @test results["Zircon_Yb"] ≈ [1997.4204160075794, 1203.8518277950204, NaN, NaN, NaN, NaN, NaN, NaN, NaN, NaN, NaN, NaN, NaN, NaN, NaN, NaN]  nans=true atol=0.1
    @test results["D_Zircon_Yb"] ≈ [204.40572042369885, 173.0962947949238, 146.517275477939, 127.13397493623552, 110.75830818807661, 97.19355790478029, 85.90281398506957, 76.42272804273595, 68.39876667486593, 61.53349730851841, 55.67059237112709, 50.60736051666041, 46.211854431373546, 42.165972409851406, 38.813436366872956, 35.85810012188556]  nans=true atol=0.1

    ## --- End of PerpleX tests
end

